

Analytics 
=====================================

Row
-------------------------------------


```{r}
     #..............................Table.............................
rct_targets <- 
  shared_df_summary |> 
  reactable(
    rowStyle = group_border_sort("city"),
    columns = list(
      city = colDef(name = "City",
                    cell = function(value, index) {
                      country <- shared_df_summary$data()$country[index]
                      region <- shared_df_summary$data()$region[index]
                      div(div(style = "font-weight: 600", value),
                          div(style = "font-size: 0.75rem;color:grey", country),
                          div(style = "font-size: 0.75rem;color:grey", region))
                      },
                    style = group_merge_sort("city")),
      has_cap = colDef(show = FALSE, name = "Has CAP?", maxWidth = 60),
      country = colDef(show = FALSE),
      region = colDef(show = FALSE),
      target_conditionality = colDef(show = TRUE, name = "Target conditionality"),
      year_of_implementation = colDef(show = TRUE, name = "Year of implementation", maxWidth = 100,
                                      cell = color_tiles(
                                        data = shared_df_summary$data(),
                                        colors = c40_colors("blue"),
                                        opacity = 0.7,
                                        bold_text = TRUE,
                                        box_shadow = TRUE
                                      )
      ),
      target_year = colDef(show = TRUE, name = "Target year", maxWidth = 100),
      reduction_value = colDef(show = TRUE, name = "Reduction value (%)",
                               vAlign = "center",
                               align = 'center', 
                               minWidth = 150,
                               cell = gauge_chart(
                                 data = tb_city_targets |> select(city, reduction_value),
                                 size = 1,
                                 fill_color =  c(c40_colors("red"), c40_colors("yellow"), c40_colors("green")), 
                                 min_value = 0, max_value = 100
                               ))
      
    ),
    outlined = TRUE
    
  )

```

```{r}
tb_target_hist <- df_targets_clean |> 
  distinct(city, year_of_implementation) |> 
  slice_max(year_of_implementation, by = city) |> 
  count(year_of_implementation)


sparkbar <- 
  plot_ly(tb_target_hist, 
                     x = ~as.factor(year_of_implementation), y = ~n,
          marker = list(color = c40_colors("blue")
                        # line = list(color = 'rgb(8,48,107)',
                        #             width = 1.5)
                        )
          ) |> 
  add_bars(fill = c40_colors("blue")) %>%
  layout(
    xaxis = list(visible = T, showgrid = F, title = ""),
    yaxis = list(visible = F, showgrid = F, title = ""),
    #hovermode = "x",
    margin = list(t = 0, r = 0, l = 0, b = 0),
    font = list(color = "white"),
    paper_bgcolor = "transparent",
    plot_bgcolor = "transparent"
  ) %>%
  config(displayModeBar = F) %>%
  htmlwidgets::onRender(
    "function(el) {
      var ro = new ResizeObserver(function() {
         var visible = el.offsetHeight > 200;
         Plotly.relayout(el, {'xaxis.visible': visible});
      });
      ro.observe(el);
    }"
  )

vbs <- list(
  value_box(
    #height = "100px",
    title = "City with at least one target reported",
    value = length(unique(df_targets_clean$city)),
    showcase = bs_icon("crosshair2"),
    theme = value_box_theme(bg = "white", fg = c40_colors("blue")),
    class = "border"
  ),
  value_box(
    #height = "100px",
    title = "Year of implementation",
    value = sparkbar,
    #value = glue("2023: {target_2023} cities"),
    # p(glue("2022: {target_2022}")),
    # p(glue("2021: {target_2021}")),
    # p(glue("2020: {target_2020}")),
    #showcase = bs_icon("graph-up"),
    #showcase = sparkbar,
    theme = value_box_theme(bg = "white", fg = c40_colors("blue")),
    class = "border"
  )
)
```

```{r}
#img_src_2 <- knitr::image_uri(here::here("style/img/under-construction.png"))

page_fillable(
  
  #h1(strong(reactablefmtr::html(glue::glue("<img src={img_src_2} width='60' height='55'> Page under maintainance, values inside are not valid")))),
  
  card(
    full_screen = TRUE,
    layout_columns(
      height = "150",
      #width = 1/2,
      fill = TRUE,
      vbs[[1]], vbs[[2]]
    ),
    #card_header("GHG targets"),
    layout_sidebar(
      fillable = TRUE, 
      sidebar = sidebar(
        title = "Filters",
        bg = c40_colors("green"),
        width = "20%",
        class = "fw-bold font-monospace",
        city_filter_summary,
        country_filter_summary,
        region_filter_summary,
        conditionality_filter_summary,
        year_target_summary
      ),
      rct_targets
    )
  )
  
)
```
